#define BLYNK_TEMPLATE_ID "TMPL6r-fh1qHu"
#define BLYNK_TEMPLATE_NAME "cobaaanini"
#define BLYNK_AUTH_TOKEN "weofs0Sy_xfyHyRq8-k8W7FboPYT4tuX"
//#include <WiFiClient.h>

#include <ESP8266WiFi.h>

int Gas_analog = A0;
int buzzer = D6;

#include <ESP8266WebServer.h>
#include <ESP8266mDNS.h>
#include <DHT11.h>
#include <BlynkSimpleEsp8266.h>

#define DHT_PIN_DATA D4 // pasang di pin data 4(D4)
#define LED_RED D1
#define LED_GREEN D2

char ssid[] = "Dean1";  // Enter your WIFI Name
char pass[] = "098765432w";  // Enter your WIFI Password
char server[] = "suhufiltering.000webhostapp.com";

WiFiClient client;
DHT11 dht11(DHT_PIN_DATA);
BlynkTimer timer;

float humidityData;
float temperatureData;

void setup() {
  Blynk.begin(BLYNK_AUTH_TOKEN, ssid, pass);
  pinMode(Gas_analog, INPUT);
  pinMode (buzzer, OUTPUT);
  pinMode(LED_RED, OUTPUT);
  pinMode(LED_GREEN, OUTPUT);

  Serial.begin(9600);
  Serial.println();
  Serial.println();
  Serial.print("Connecting to ");
  Serial.println(ssid);

  WiFi.begin(ssid, pass);

  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  Serial.println("");
  Serial.println("WiFi connected");
  Serial.println("Server started");
  Serial.print(WiFi.localIP());
  delay(1000);
  Serial.println("connecting...");
  timer.setInterval(1000L, sendSensor);
}

void Sending_To_phpmyadmindatabase() {
    float h = dht11.readHumidity();
    float t = dht11.readTemperature();
    int gas = analogRead(Gas_analog);

    if (client.connect(server, 80)) {
        Serial.println("connected");

        // Send data to the PHP script
        client.println("POST /fetch.php HTTP/1.1");
        client.print("Host: suhufiltering.000webhostapp.com\r\n");
        client.print("Content-Type: application/x-www-form-urlencoded\r\n");
        client.print("Connection: close\r\n");
        client.print("Content-Length: ");
        client.println(strlen("humidity=") + String(h).length() + strlen("&temperature=") + String(t).length() + strlen("&gas=") + String(gas).length());
        client.println();
        client.print("humidity=");
        client.print(h);
        client.print("&temperature=");
        client.print(t);
        client.print("&gas=");
        client.print(gas);

        // Wait for the response
        while (client.connected() && !client.available()) delay(10);

        // Print the response
        while (client.available()) {
            Serial.write(client.read());
        }

        client.stop();
    } else {
        Serial.println("connection failed");
    }
}

void sendSensor() {
  float h = dht11.readHumidity();
  float t = dht11.readTemperature();
  float g = analogRead(Gas_analog);
  if (isnan(h) || isnan(t)) {
    Serial.println("Failed to read from DHT sensor!");
    return;
  }

  // You can send any value at any time.
  // Please don't send more than 10 values per second.
  Blynk.virtualWrite(V13, h);  // V13 is for Humidity
  Blynk.virtualWrite(V14, t);  // V14 is for Temperature
  Blynk.virtualWrite(V117, g);  // V14 is for Temperature
}

void loop() {
  Blynk.run();
  timer.run();

  float temperature = dht11.readTemperature();
  float humidity = dht11.readHumidity();
  humidityData = humidity;
  temperatureData = temperature;
  Sending_To_phpmyadmindatabase();

  Serial.print("Humidity: ");
  Serial.print(humidity);
  Serial.print(" %\t");
  Serial.print("Temperature: ");
  Serial.print(temperature);
  Serial.println(" Â°C");

  if (temperature >= 33) {
    digitalWrite(LED_RED, HIGH);
    digitalWrite(LED_GREEN, LOW);
    //tone(buzzer, 6000, 300);
    digitalWrite (buzzer, HIGH);
    delay(1000);
  }  else {
    digitalWrite(LED_RED, LOW);
    digitalWrite(LED_GREEN, HIGH);
    //noTone(buzzer);
    digitalWrite (buzzer, LOW);
  }
int gas = analogRead(Gas_analog);

  Serial.print("Gas Sensor : ");
  Serial.print(gas);
  Serial.print("\t");
    if (gas > 460) {
      Serial.println("Gas");
      digitalWrite(buzzer, HIGH);
      //delay(1000);
    }else{
      Serial.println("Tidak Ada Gas");
      digitalWrite(buzzer, LOW);
    }
    delay(1000);
}